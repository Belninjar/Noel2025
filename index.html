<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Craft QR</title>
  <style>
    :root {
      --w: 1365;
      --h: 2048;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      /* Zones (en %) */
      --cam-left: 29.82%;
      --cam-top: 24.66%;
      --cam-width: 40.29%;
      --cam-height: 18.31%;

      --slot1-left: 13.76%;
      --slot1-top: 56.15%;
      --slot1-width: 17.3%;
      --slot1-height: 11.52%;

      --slot2-left: 69.33%;
      --slot2-top: 56.15%;
      --slot2-width: 17.3%;
      --slot2-height: 11.52%;

      --msg-left: 5.15%;
      --msg-top: 80.79%;
      --msg-width: 89.75%;
      --msg-height: 15.95%;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: #0b0b0b;
      display: grid;
      place-items: center;
      font-family: var(--font);
      overscroll-behavior: none;
      touch-action: manipulation;
    }

    /* Plateau (image de fond) */
    #board {
      position: relative;
      width: min(100vw, calc(100vh * (var(--w) / var(--h))));
      aspect-ratio: var(--w) / var(--h);
      background: url("UI.png") center/contain no-repeat;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Zone caméra */
    #camRegion {
      position: absolute;
      left: var(--cam-left);
      top: var(--cam-top);
      width: var(--cam-width);
      height: var(--cam-height);
      overflow: hidden;
      border-radius: 18px;
      background: #000;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: translateZ(0);
    }

    #camOverlay {
      position: absolute;
      inset: 0;
      display: grid;
      place-itemsContent: center;
      padding: 12px;
      text-align: center;
      color: rgba(255,255,255,0.92);
      font-weight: 800;
      text-shadow: 0 2px 12px rgba(0,0,0,0.9);
      background: linear-gradient(to bottom, rgba(0,0,0,0.55), rgba(0,0,0,0.15));
      pointer-events: none;
      opacity: 1;
      transition: opacity .2s ease;
    }
    #camOverlay.hidden { opacity: 0; }

    #tinyControls {
      position: absolute;
      left: 10px;
      top: 10px;
      display: flex;
      gap: 8px;
      z-index: 3;
    }

    .tinyBtn {
      border: 0;
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 800;
      cursor: pointer;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }
    .tinyBtn:active { transform: translateY(1px); }

    /* Slots cartes */
    .slot {
      position: absolute;
      overflow: hidden;
      border-radius: 10px;
    }
    #slot1 { left: var(--slot1-left); top: var(--slot1-top); width: var(--slot1-width); height: var(--slot1-height); }
    #slot2 { left: var(--slot2-left); top: var(--slot2-top); width: var(--slot2-width); height: var(--slot2-height); }

    .slot img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
      cursor: pointer;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,0.35));
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== TEXTE: transparent + blanc + toujours dans le cadre ===== */
    #messageBox {
      position: absolute;
      left: var(--msg-left);
      top: var(--msg-top);
      width: var(--msg-width);
      height: var(--msg-height);         /* hauteur fixe pour pouvoir “fit” le texte */
      padding: 10px 12px;

      background: transparent;
      border: none;
      box-shadow: none;

      color: #fff;
      font-weight: 900;
      line-height: 1.15;
      text-align: center;
      white-space: pre-line;
      overflow: hidden;                 /* empêche de déborder */

      /* taille de base, puis JS réduira si nécessaire */
      font-size: clamp(14px, 2.2vw, 30px);

      /* lisibilité sur fond */
      text-shadow: 0 2px 10px rgba(0,0,0,0.9);

      display: flex;
      align-items: center;
      justify-content: center;
    }
    #messageBox.ok  { text-shadow: 0 2px 10px rgba(0,0,0,0.9), 0 0 14px rgba(60, 200, 120, 0.35); }
    #messageBox.bad { text-shadow: 0 2px 10px rgba(0,0,0,0.9), 0 0 14px rgba(240, 80, 80, 0.35); }

    /* Démarrage caméra via geste utilisateur */
    #startHitbox {
      position: absolute;
      inset: 0;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="board">
    <div id="camRegion">
      <video id="video" playsinline muted></video>

      <div id="tinyControls">
        <button class="tinyBtn" id="btnStop" title="Arrêter la caméra" style="display:none;">⏹</button>
        <button class="tinyBtn" id="btnReset" title="Retirer les 2 cartes">↺</button>
      </div>

      <div id="camOverlay">
        Touchez ici pour activer la caméra<br/>
        puis scannez 2 QR codes
      </div>

      <div id="startHitbox" aria-label="Démarrer la caméra"></div>
    </div>

    <div id="slot1" class="slot"><img id="img1" alt="Carte 1" /></div>
    <div id="slot2" class="slot"><img id="img2" alt="Carte 2" /></div>

    <div id="messageBox">Prêt. Scanne une première carte.</div>
  </div>

  <!-- QR-SCANNER (UMD) + Worker -->
  <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
  <script>
    QrScanner.WORKER_PATH = "https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js";
  </script>

  <script>
    /**
     * ===== CONFIG =====
     * UI.png à côté du fichier.
     * Images cartes : /cards/0001.png etc.
     */
    const CARD_IMAGE_BASE = "cards/";
    const CARD_IMAGE_EXTS = ["png", "jpg", "jpeg", "webp"];

    function keyOf(a, b) {
      const A = String(a).trim();
      const B = String(b).trim();
      return [A, B].sort().join("|");
    }

    const RECIPES = {
      [keyOf("0001","0002")]: { item: "Hache" },
      [keyOf("0003","0001")]: { item: "Bouclier", newCards: ["Récupère 0005"] },
      [keyOf("0005","0006")]: { item: "Potion",   newCards: ["Récupère 0004", "Récupère 0002"] },
    };

    const els = {
      startHitbox: document.getElementById("startHitbox"),
      camOverlay: document.getElementById("camOverlay"),
      btnStop: document.getElementById("btnStop"),
      btnReset: document.getElementById("btnReset"),
      video: document.getElementById("video"),
      msg: document.getElementById("messageBox"),
      img1: document.getElementById("img1"),
      img2: document.getElementById("img2"),
    };

    let qrScanner = null;
    let slot1 = null;
    let slot2 = null;

    const COOLDOWN_MS = 1200;
    const lastSeen = new Map();

    // 1x1 transparent (évite les erreurs de chargement quand on “vide” une image)
    const BLANK_IMG = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";

    function fitMessageText() {
      // Réduit la taille du texte jusqu’à ce qu’il tienne dans le cadre
      const el = els.msg;
      el.style.fontSize = ""; // reset à la valeur CSS (clamp)
      const computed = getComputedStyle(el);
      let size = parseFloat(computed.fontSize) || 18;
      const min = 12;

      // Si ça déborde, on diminue
      while (el.scrollHeight > el.clientHeight && size > min) {
        size -= 1;
        el.style.fontSize = size + "px";
      }
    }

    function setMessage(text, kind = "") {
      els.msg.textContent = text;
      els.msg.classList.remove("ok", "bad");
      if (kind) els.msg.classList.add(kind);

      // fit après layout
      requestAnimationFrame(fitMessageText);
    }

    function normalizeCode(raw) {
      const s = String(raw ?? "").trim();
      const m = s.match(/\b\d{4}\b/);
      return (m ? m[0] : s).trim();
    }

    function clearSlot(n) {
      const imgEl = (n === 1) ? els.img1 : els.img2;

      // IMPORTANT: on neutralise les handlers avant de changer src (sinon “image introuvable” au clic)
      imgEl.onerror = null;
      imgEl.onload = null;

      if (n === 1) slot1 = null; else slot2 = null;

      imgEl.removeAttribute("data-code");
      imgEl.style.display = "none";
      imgEl.src = BLANK_IMG; // pas d’erreur réseau

      if (!slot1 && !slot2) {
        setMessage("Prêt. Scanne une première carte.");
      } else if (slot1 && !slot2) {
        setMessage("Carte 1 en place.\nScanne la deuxième carte.");
      } else if (!slot1 && slot2) {
        setMessage("Carte 2 en place.\nScanne la première carte.");
      } else {
        evaluateCraft();
      }
    }

    function clearBoth() {
      clearSlot(1);
      clearSlot(2);
    }

    function setSlotImage(imgEl, code) {
      // reset handlers
      imgEl.onerror = null;
      imgEl.onload = null;

      imgEl.style.display = "block";
      imgEl.setAttribute("data-code", code);

      let idx = 0;

      const tryNext = () => {
        // Si le slot a changé entre-temps (clic / autre scan), on arrête.
        if (imgEl.getAttribute("data-code") !== code) return;

        if (idx >= CARD_IMAGE_EXTS.length) {
          // Image réellement absente -> message d’erreur (pas lié au clic)
          setMessage(
            `Image introuvable pour le code ${code}.\nVérifie: ${CARD_IMAGE_BASE}${code}.png`,
            "bad"
          );
          return;
        }
        const ext = CARD_IMAGE_EXTS[idx++];
        imgEl.src = `${CARD_IMAGE_BASE}${code}.${ext}`;
      };

      imgEl.onerror = () => {
        // Si le slot a été vidé, on ignore l’erreur
        if (imgEl.getAttribute("data-code") !== code) return;
        tryNext();
      };

      tryNext();
    }

    function placeCard(code) {
      if (slot1 && slot2) {
        setMessage("Deux cartes déjà en place.\nTouchez une carte pour la retirer et rescanner.", "bad");
        return;
      }

      if (!slot1) {
        slot1 = code;
        setSlotImage(els.img1, code);
        setMessage("Carte 1 enregistrée.\nScanne la deuxième carte.");
        return;
      }

      if (!slot2) {
        slot2 = code;
        setSlotImage(els.img2, code);
        evaluateCraft();
      }
    }

    function evaluateCraft() {
      if (!slot1 || !slot2) return;

      const k = keyOf(slot1, slot2);
      const recipe = RECIPES[k];

      if (!recipe) {
        if (navigator.vibrate) navigator.vibrate([40, 60, 40]);
        setMessage("Mauvaise association.\nTouchez une carte pour la retirer.", "bad");
        return;
      }

      const lines = [
        `Objet crafté : ${recipe.item}`,
        ...(recipe.newCards?.length ? ["", "À récupérer :", ...recipe.newCards.map(x => `• ${x}`)] : [])
      ];

      if (navigator.vibrate) navigator.vibrate(80);
      setMessage(lines.join("\n"), "ok");
    }

    function onDetected(raw) {
      const code = normalizeCode(raw);
      if (!code) return;

      const now = Date.now();
      const last = lastSeen.get(code) || 0;
      if (now - last < COOLDOWN_MS) return;
      lastSeen.set(code, now);

      placeCard(code);
    }

    async function startScanner() {
      if (qrScanner) return;

      qrScanner = new QrScanner(
        els.video,
        (result) => onDetected(result?.data ?? result),
        {
          preferredCamera: "environment",
          returnDetailedScanResult: true,
          maxScansPerSecond: 12,
        }
      );

      try {
        await qrScanner.start();
        els.camOverlay.classList.add("hidden");
        els.btnStop.style.display = "inline-block";
        if (!slot1 && !slot2) setMessage("Caméra active.\nScanne une première carte.");
      } catch {
        qrScanner.destroy();
        qrScanner = null;
        setMessage("Impossible d’accéder à la caméra.\nOuvre la page en HTTPS (ou localhost) et accepte la permission.", "bad");
      }
    }

    function stopScanner() {
      if (!qrScanner) return;
      qrScanner.stop();
      qrScanner.destroy();
      qrScanner = null;
      els.btnStop.style.display = "none";
      els.camOverlay.classList.remove("hidden");
      setMessage("Caméra arrêtée.\nTouchez l’écran caméra pour redémarrer.");
    }

    // Events
    els.startHitbox.addEventListener("click", startScanner);
    els.startHitbox.addEventListener("touchend", (e) => { e.preventDefault(); startScanner(); }, { passive: false });

    els.btnStop.addEventListener("click", stopScanner);
    els.btnReset.addEventListener("click", clearBoth);

    // Tap sur carte => suppression sans déclencher d’erreur d’image
    els.img1.addEventListener("click", () => clearSlot(1));
    els.img2.addEventListener("click", () => clearSlot(2));
    els.img1.addEventListener("touchend", (e) => { e.preventDefault(); clearSlot(1); }, { passive: false });
    els.img2.addEventListener("touchend", (e) => { e.preventDefault(); clearSlot(2); }, { passive: false });

    window.addEventListener("beforeunload", () => {
      if (qrScanner) {
        qrScanner.stop();
        qrScanner.destroy();
        qrScanner = null;
      }
    });

    // init fit
    requestAnimationFrame(fitMessageText);
  </script>
</body>
</html>

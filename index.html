<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Craft QR</title>
  <style>
    :root {
      --w: 1365;
      --h: 2048;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      /* Zones (en %) calculées sur l’image fournie */
      --cam-left: 29.82%;
      --cam-top: 24.66%;
      --cam-width: 40.29%;
      --cam-height: 18.31%;

      --slot1-left: 16.996%;
      --slot1-top: 56.15%;
      --slot1-width: 14.73%;
      --slot1-height: 10.74%;

      --slot2-left: 68.205%;
      --slot2-top: 56.15%;
      --slot2-width: 14.58%;
      --slot2-height: 10.84%;

      --msg-left: 10%;
      --msg-top: 70%;
      --msg-width: 80%;
      --msg-height: 22%;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: #0b0b0b;
      display: grid;
      place-items: center;
      font-family: var(--font);
      overscroll-behavior: none;
      touch-action: manipulation;
    }

    /* Plateau (image de fond) */
    #board {
      position: relative;
      width: min(100vw, calc(100vh * (var(--w) / var(--h))));
      aspect-ratio: var(--w) / var(--h);
      background: url("UI.png") center/contain no-repeat;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Zone caméra (dans le carré noir) */
    #camRegion {
      position: absolute;
      left: var(--cam-left);
      top: var(--cam-top);
      width: var(--cam-width);
      height: var(--cam-height);
      overflow: hidden;
      border-radius: 18px;
      background: #000;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: translateZ(0);
    }

    #camOverlay {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      padding: 12px;
      text-align: center;
      color: rgba(255,255,255,0.92);
      font-weight: 700;
      text-shadow: 0 1px 8px rgba(0,0,0,0.8);
      background: linear-gradient(to bottom, rgba(0,0,0,0.55), rgba(0,0,0,0.15));
      pointer-events: none;
      opacity: 1;
      transition: opacity .2s ease;
    }
    #camOverlay.hidden { opacity: 0; }

    #tinyControls {
      position: absolute;
      left: 10px;
      top: 10px;
      display: flex;
      gap: 8px;
      z-index: 3;
    }

    .tinyBtn {
      border: 0;
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 700;
      cursor: pointer;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }
    .tinyBtn:active { transform: translateY(1px); }

    /* Slots cartes */
    .slot {
      position: absolute;
      overflow: hidden;
      border-radius: 10px;
    }
    #slot1 { left: var(--slot1-left); top: var(--slot1-top); width: var(--slot1-width); height: var(--slot1-height); }
    #slot2 { left: var(--slot2-left); top: var(--slot2-top); width: var(--slot2-width); height: var(--slot2-height); }

    .slot img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none; /* visible uniquement quand une carte est posée */
      cursor: pointer;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,0.35));
      -webkit-tap-highlight-color: transparent;
    }

    /* Message (zone du bas) */
    #messageBox {
      position: absolute;
      left: var(--msg-left);
      top: var(--msg-top);
      width: var(--msg-width);
      min-height: var(--msg-height);
      padding: 14px 14px;
      border-radius: 16px;
      background: rgba(255, 248, 220, 0.92);
      border: 2px solid rgba(120, 80, 30, 0.65);
      box-shadow: 0 18px 28px rgba(0,0,0,0.28);
      color: #2b1a0d;
      font-weight: 700;
      line-height: 1.25;
      white-space: pre-line;
    }
    #messageBox.ok {
      background: rgba(232, 255, 236, 0.92);
      border-color: rgba(60, 160, 90, 0.6);
    }
    #messageBox.bad {
      background: rgba(255, 235, 235, 0.92);
      border-color: rgba(190, 70, 70, 0.6);
    }

    /* Zone cliquable pour démarrer la caméra (exigence navigateur) */
    #startHitbox {
      position: absolute;
      inset: 0;
      cursor: pointer;
    }

    /* Debug discret (optionnel) */
    #debug {
      position: absolute;
      left: 10px;
      bottom: 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.75);
      text-shadow: 0 1px 8px rgba(0,0,0,0.8);
      display: none;
    }
  </style>
</head>
<body>
  <div id="board">
    <div id="camRegion">
      <video id="video" playsinline muted></video>

      <div id="tinyControls">
        <button class="tinyBtn" id="btnStop" title="Arrêter la caméra" style="display:none;">⏹</button>
        <button class="tinyBtn" id="btnReset" title="Retirer les 2 cartes">↺</button>
      </div>

      <div id="camOverlay">
        Touchez ici pour activer la caméra<br/>
        puis scannez 2 QR codes
      </div>

      <!-- hitbox de démarrage (au-dessus de la vidéo) -->
      <div id="startHitbox" aria-label="Démarrer la caméra"></div>
    </div>

    <div id="slot1" class="slot"><img id="img1" alt="Carte 1" /></div>
    <div id="slot2" class="slot"><img id="img2" alt="Carte 2" /></div>

    <div id="messageBox">Prêt. Scanne une première carte.</div>

    <div id="debug"></div>
  </div>

  <!-- QR-SCANNER (UMD) + Worker -->
  <!-- Option production : télécharge ces 2 fichiers et sers-les en local pour éviter la dépendance CDN -->
  <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
  <script>
    QrScanner.WORKER_PATH = "https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js";
  </script>

  <script>
    /**
     * ===== CONFIG =====
     * 1) Mets l’image UI en "UI.png" à côté de ce fichier.
     * 2) Mets les images des cartes dans /cards/ avec le nom EXACT du code:
     *    ex: cards/0001.png, cards/0002.png, etc.
     */
    const CARD_IMAGE_BASE = "cards/";
    const CARD_IMAGE_EXTS = ["png", "jpg", "jpeg", "webp"];

    // Recettes (exemples)
    function keyOf(a, b) {
      const A = String(a).trim();
      const B = String(b).trim();
      return [A, B].sort().join("|");
    }

    const RECIPES = {
      [keyOf("0001","0002")]: { item: "Hache", newCards: ["Récupère 0003", "Récupère 0004"] },
      [keyOf("0003","0001")]: { item: "Bouclier", newCards: ["Récupère 0005"] },
      [keyOf("0005","0006")]: { item: "Potion", newCards: ["Récupère 0004", "Récupère 0002"] },
    };

    /**
     * ===== UI / STATE =====
     */
    const els = {
      startHitbox: document.getElementById("startHitbox"),
      camOverlay: document.getElementById("camOverlay"),
      btnStop: document.getElementById("btnStop"),
      btnReset: document.getElementById("btnReset"),
      video: document.getElementById("video"),
      msg: document.getElementById("messageBox"),
      img1: document.getElementById("img1"),
      img2: document.getElementById("img2"),
      debug: document.getElementById("debug"),
    };

    let qrScanner = null;
    let slot1 = null; // code
    let slot2 = null; // code

    // anti spam scan (évite déclenchement multiple)
    const COOLDOWN_MS = 1200;
    const lastSeen = new Map(); // code -> time

    function setMessage(text, kind = "") {
      els.msg.textContent = text;
      els.msg.classList.remove("ok", "bad");
      if (kind) els.msg.classList.add(kind);
    }

    function normalizeCode(raw) {
      const s = String(raw ?? "").trim();
      // robuste: si le QR contient autre chose, on extrait un bloc 4 chiffres si possible
      const m = s.match(/\b\d{4}\b/);
      return (m ? m[0] : s).trim();
    }

    function clearSlot(n) {
      if (n === 1) {
        slot1 = null;
        els.img1.removeAttribute("data-code");
        els.img1.style.display = "none";
        els.img1.src = "";
      } else {
        slot2 = null;
        els.img2.removeAttribute("data-code");
        els.img2.style.display = "none";
        els.img2.src = "";
      }

      if (!slot1 && !slot2) {
        setMessage("Prêt. Scanne une première carte.");
      } else if (slot1 && !slot2) {
        setMessage("Carte 1 en place. Scanne la deuxième carte.");
      } else if (!slot1 && slot2) {
        setMessage("Carte 2 en place. Scanne la première carte.");
      } else {
        // 2 cartes en place => on réévalue
        evaluateCraft();
      }
    }

    function clearBoth() {
      clearSlot(1);
      clearSlot(2);
    }

    function setSlotImage(imgEl, code) {
      imgEl.style.display = "block";
      imgEl.setAttribute("data-code", code);

      // Essaye plusieurs extensions en fallback
      let idx = 0;
      function tryNext() {
        if (idx >= CARD_IMAGE_EXTS.length) {
          // fallback "introuvable"
          imgEl.style.display = "block";
          imgEl.src = "";
          imgEl.alt = `Image introuvable (${code})`;
          setMessage(`Image introuvable pour le code ${code}.\nVérifie: ${CARD_IMAGE_BASE}${code}.png`, "bad");
          return;
        }
        const ext = CARD_IMAGE_EXTS[idx++];
        imgEl.src = `${CARD_IMAGE_BASE}${code}.${ext}`;
      }

      imgEl.onerror = () => tryNext();
      tryNext();
    }

    function placeCard(code) {
      // slots pleins => on ignore jusqu’à suppression
      if (slot1 && slot2) {
        setMessage("Deux cartes déjà en place.\nTouchez une carte pour la retirer et rescanner.", "bad");
        return;
      }

      if (!slot1) {
        slot1 = code;
        setSlotImage(els.img1, code);
        setMessage("Carte 1 enregistrée.\nScanne la deuxième carte.");
        return;
      }

      if (!slot2) {
        slot2 = code;
        setSlotImage(els.img2, code);
        evaluateCraft();
      }
    }

    function evaluateCraft() {
      if (!slot1 || !slot2) return;

      const k = keyOf(slot1, slot2);
      const recipe = RECIPES[k];

      if (!recipe) {
        if (navigator.vibrate) navigator.vibrate([40, 60, 40]);
        setMessage("Mauvaise association.\nTouchez une carte pour la retirer.", "bad");
        return;
      }

      const lines = [
        `✅ Objet crafté : ${recipe.item}`,
        ...(recipe.newCards?.length ? ["", "À récupérer :", ...recipe.newCards.map(x => `• ${x}`)] : [])
      ];

      if (navigator.vibrate) navigator.vibrate(80);
      setMessage(lines.join("\n"), "ok");
    }

    function onDetected(raw) {
      const code = normalizeCode(raw);
      if (!code) return;

      const now = Date.now();
      const last = lastSeen.get(code) || 0;
      if (now - last < COOLDOWN_MS) return;
      lastSeen.set(code, now);

      // Optionnel: si on veut refuser les codes inconnus, ajouter un check ici.
      placeCard(code);
    }

    /**
     * ===== CAMERA / SCANNER =====
     */
    async function startScanner() {
      if (qrScanner) return; // déjà démarré

      // création scanner
      qrScanner = new QrScanner(
        els.video,
        (result) => onDetected(result?.data ?? result),
        {
          preferredCamera: "environment",
          returnDetailedScanResult: true,
          maxScansPerSecond: 12,
          // highlightScanRegion: true,
          // highlightCodeOutline: true,
        }
      );

      try {
        await qrScanner.start();
        els.camOverlay.classList.add("hidden");
        els.btnStop.style.display = "inline-block";
        setMessage(slot1 || slot2 ? els.msg.textContent : "Caméra active.\nScanne une première carte.");
      } catch (e) {
        qrScanner.destroy();
        qrScanner = null;
        setMessage("Impossible d’accéder à la caméra.\nOuvre la page en HTTPS (ou localhost) et accepte la permission.", "bad");
      }
    }

    function stopScanner() {
      if (!qrScanner) return;
      qrScanner.stop();
      qrScanner.destroy();
      qrScanner = null;
      els.btnStop.style.display = "none";
      els.camOverlay.classList.remove("hidden");
      setMessage("Caméra arrêtée.\nTouchez l’écran caméra pour redémarrer.");
    }

    /**
     * ===== EVENTS =====
     */
    // Démarrage caméra (obligatoire via geste utilisateur)
    els.startHitbox.addEventListener("click", startScanner);
    els.startHitbox.addEventListener("touchend", (e) => { e.preventDefault(); startScanner(); }, { passive: false });

    els.btnStop.addEventListener("click", stopScanner);
    els.btnReset.addEventListener("click", clearBoth);

    // Tap sur carte => suppression (permet le rescan)
    els.img1.addEventListener("click", () => clearSlot(1));
    els.img2.addEventListener("click", () => clearSlot(2));
    els.img1.addEventListener("touchend", (e) => { e.preventDefault(); clearSlot(1); }, { passive: false });
    els.img2.addEventListener("touchend", (e) => { e.preventDefault(); clearSlot(2); }, { passive: false });

    // Nettoyage
    window.addEventListener("beforeunload", () => {
      if (qrScanner) {
        qrScanner.stop();
        qrScanner.destroy();
        qrScanner = null;
      }
    });
  </script>
</body>
</html>
